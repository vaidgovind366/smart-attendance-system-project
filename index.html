<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance | Live Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --cyan-primary: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            --cyan-glow: rgba(0, 242, 254, 0.4);
            --cyan-glow-hover: rgba(0, 242, 254, 0.8);
            --orange-heading: #f2994a;
            --data-positive: #10b981; 
            
            --bg-gradient-1: rgba(10, 25, 47, 0.9);
            --bg-gradient-2: rgba(0, 0, 0, 0.8);
            --glass-bg: rgba(15, 32, 39, 0.65);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            --glass-bg-light: rgba(255, 255, 255, 0.03);
            --glass-bg-hover: rgba(255, 255, 255, 0.1);
            
            --text-main: #ffffff;
            --text-muted: #d1d5db;
            
            --empty-heat: rgba(255, 255, 255, 0.05);
            --cam-placeholder: rgba(0, 0, 0, 0.6);
        }

        body.light-theme {
            --bg-gradient-1: rgba(243, 244, 246, 0.9);
            --bg-gradient-2: rgba(229, 231, 235, 0.95);
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.05);
            --glass-highlight: rgba(255, 255, 255, 0.8);
            --glass-bg-light: rgba(255, 255, 255, 0.5);
            --glass-bg-hover: rgba(255, 255, 255, 0.9);
            
            --text-main: #111827; 
            --text-muted: #4b5563; 
            
            --empty-heat: rgba(0, 0, 0, 0.05);
            --cam-placeholder: rgba(0, 0, 0, 0.05);
            --orange-heading: #d97706; 
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; padding: 20px; color: var(--text-main);
            background-image: linear-gradient(to right bottom, var(--bg-gradient-1), var(--bg-gradient-2)), url('https://images.unsplash.com/photo-1541339907198-e08756dedf3f?auto=format&fit=crop&w=2070&q=80');
            background-size: cover; background-attachment: fixed; overflow-x: hidden; transition: background 0.5s ease, color 0.5s ease;
        }
        * { transition: background-color 0.4s ease, border-color 0.4s ease, color 0.4s ease, box-shadow 0.4s ease; box-sizing: border-box; }
        h1, h2, h3, h4 { color: var(--orange-heading) !important; margin-top: 0; text-shadow: 0 2px 10px rgba(242, 153, 74, 0.2); letter-spacing: 0.5px; }

        /* SKELETONS */
        .stagger-in { opacity: 0; transform: translateY(30px); animation: fadeUp 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }
        .skeleton { background: linear-gradient(90deg, var(--glass-bg-light) 25%, var(--glass-bg-hover) 50%, var(--glass-bg-light) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite linear; border-radius: 6px; color: transparent !important; user-select: none; }
        .skeleton * { visibility: hidden; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .skeleton-block { height: 24px; width: 100%; border-radius: 4px; }
        .skeleton-avatar { width: 32px; height: 32px; border-radius: 50%; display: inline-block; }

        /* CARDS */
        .glass-card { background: var(--glass-bg); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); border: 1px solid var(--glass-border); border-top: 1px solid var(--glass-highlight); border-left: 1px solid var(--glass-highlight); border-radius: 16px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .glass-card:hover { transform: translateY(-6px); box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4); border-color: var(--primary); z-index: 10; }

        /* LAYOUT */
        .top-nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .top-right-nav { display: flex; gap: 10px; flex-wrap: wrap; }
        .nav-btn { background: var(--glass-bg-light); border: 1px solid var(--glass-border); color: var(--text-main); padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px; position: relative; backdrop-filter: blur(10px); justify-content: center; }
        .nav-btn:hover { transform: translateY(-3px); background: var(--glass-bg-hover); border-color: var(--primary); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .btn-logout:hover { background: #ff4c4c; border-color: #ff4c4c; color: white;}

        .notif-badge { position: absolute; top: -6px; right: -6px; background: #ff4c4c; color: white; font-size: 11px; font-weight: bold; height: 18px; min-width: 18px; padding: 0 4px; border-radius: 10px; display: none; justify-content: center; align-items: center; box-shadow: 0 0 10px rgba(255, 76, 76, 0.8); }
        .badge-animate { animation: badgeBump 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes badgeBump { 0% { transform: scale(1); } 50% { transform: scale(1.6); box-shadow: 0 0 20px rgba(255, 76, 76, 1); } 100% { transform: scale(1); } }

        .header { text-align: center; margin-bottom: 25px; padding-bottom: 10px; }
        .header h1 { letter-spacing: 2px; font-size: 32px; }
        .header h2 { font-size: 16px; font-weight: 500; text-transform: uppercase; color: var(--orange-heading) !important; }
        .live-clock-widget { display: inline-flex; align-items: center; gap: 10px; background: var(--glass-bg-light); border: 1px solid var(--glass-border); color: var(--text-main); padding: 8px 20px; border-radius: 30px; font-size: 14px; font-weight: bold; margin-top: 15px; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); backdrop-filter: blur(5px); letter-spacing: 1px; }

        /* SUMMARY KPI CARDS */
        .summary-container { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto 25px; flex-wrap: wrap; perspective: 1000px; }
        .summary-card { padding: 20px; flex: 1; min-width: 220px; display: flex; align-items: center; gap: 18px; }
        .summary-icon { width: 60px; height: 60px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 26px; }
        .icon-blue { background: rgba(0, 242, 254, 0.1); color: #00f2fe; border: 1px solid rgba(0, 242, 254, 0.2); }
        .icon-green { background: rgba(16, 185, 129, 0.1); color: var(--data-positive); border: 1px solid rgba(16, 185, 129, 0.2); }
        .icon-red { background: rgba(255, 76, 76, 0.1); color: #ff4c4c; border: 1px solid rgba(255, 76, 76, 0.2); }
        .icon-orange { background: rgba(242, 153, 74, 0.1); color: var(--orange-heading); border: 1px solid rgba(242, 153, 74, 0.2); }
        .summary-info { flex: 1; }
        .summary-info h4 { margin: 0; font-size: 12px; color: var(--text-muted) !important; text-transform: uppercase; letter-spacing: 1px; text-shadow: none; }
        .summary-info h2 { margin: 5px 0 0; font-size: 28px; color: var(--text-main) !important; text-shadow: none; font-weight: bold; width: 60px; display: inline-block; }

        /* DASHBOARD GRID */
        .dashboard-container { display: flex; gap: 20px; max-width: 1200px; margin: 0 auto; flex-wrap: wrap; perspective: 1000px; }
        .camera-section { flex: 1.5; min-width: 300px; padding: 20px; }
        .logs-section { flex: 1; min-width: 300px; padding: 20px; display: flex; flex-direction: column; }
        .panel-card h3 { border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; margin-bottom: 20px; }

        /* BUTTONS */
        .controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; width: 100%; }
        .btn-primary { padding: 14px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: #000; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 15px; background: var(--cyan-primary); box-shadow: 0 4px 15px var(--cyan-glow); flex: 1; min-width: 200px; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-4px) scale(1.02); box-shadow: 0 8px 25px var(--cyan-glow-hover); }
        .btn-stop { background: linear-gradient(to right, #ff4c4c, #ff4b2b); box-shadow: 0 4px 15px rgba(255, 76, 76, 0.4); color: white; padding: 14px 25px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 15px; flex: 1; min-width: 200px; transition: all 0.3s; } 
        #startBtn { padding: 16px 30px; font-size: 16px; text-transform: uppercase; letter-spacing: 1px; animation: startBtnGlow 2.5s infinite alternate ease-in-out; }
        @keyframes startBtnGlow { 0% { box-shadow: 0 0 15px rgba(0,242,254,0.4); transform: scale(1); } 100% { box-shadow: 0 0 35px rgba(0,242,254,0.9), 0 0 15px rgba(255,255,255,0.4); transform: scale(1.03); } }

        /* ========================================================
           ðŸ“¸ RESTORED ORIGINAL CAMERA UI (DASHED CIRCLE)
           ======================================================== */
        .status-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; background: rgba(0,0,0,0.1); border: 1px solid var(--glass-border); border-radius: 20px; font-size: 11px; font-weight: bold; letter-spacing: 1px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; }
        .dot-offline { background: var(--text-muted); box-shadow: 0 0 8px var(--text-muted); }
        .dot-active { background: var(--data-positive); box-shadow: 0 0 8px var(--data-positive); animation: blink 1.5s infinite alternate; }
        .dot-scanning { background: #f2c94c; box-shadow: 0 0 8px #f2c94c; animation: blink 0.5s infinite alternate; }
        .dot-error { background: #ff4c4c; box-shadow: 0 0 8px #ff4c4c; }
        @keyframes blink { 0% { opacity: 0.5; } 100% { opacity: 1; transform: scale(1.2); } }

        #camera-placeholder { position: relative; width: 100%; height: 350px; border-radius: 12px; background: var(--cam-placeholder); border: 1px solid var(--glass-border); display: flex; flex-direction: column; justify-content: center; align-items: center; margin-bottom: 15px; overflow: hidden; transition: 0.5s; }
        .demo-face-box { position: absolute; width: 140px; height: 140px; border: 2px dashed rgba(0, 242, 254, 0.5); border-radius: 16px; top: 45%; left: 50%; transform: translate(-50%, -50%); animation: breatheBox 3s ease-in-out infinite; }
        @keyframes breatheBox { 0%, 100% { width: 140px; height: 140px; border-color: rgba(0, 242, 254, 0.3); } 50% { width: 160px; height: 160px; border-color: rgba(0, 242, 254, 0.8); box-shadow: 0 0 20px rgba(0, 242, 254, 0.2), inset 0 0 20px rgba(0, 242, 254, 0.1); } }
        .pulse-icon { font-size: 60px; position: relative; z-index: 2; animation: pulseIcon 2s infinite cubic-bezier(0.4, 0, 0.2, 1); }
        @keyframes pulseIcon { 0% { transform: scale(1); opacity: 0.5; color: #00f2fe; text-shadow: 0 0 0 transparent; } 50% { transform: scale(1.15); opacity: 1; text-shadow: 0 0 20px rgba(0, 242, 254, 0.5); } 100% { transform: scale(1); opacity: 0.5; } }

        #camera-wrapper { position: relative; width: 100%; height: 350px; border-radius: 12px; overflow: hidden; background: #000; border: 1px solid var(--glass-border); box-shadow: 0 10px 20px rgba(0,0,0,0.3); display: none; margin-bottom: 15px; }
        #webcam { width: 100%; height: 100%; object-fit: cover; } /* Restored Mirror effect */
        
        /* RESTORED Original Dashed Circle */
        .face-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 180px; height: 240px; border-radius: 50%; border: 3px dashed var(--data-positive); box-shadow: 0 0 0 2000px rgba(0,0,0,0.5), inset 0 0 20px rgba(16, 185, 129, 0.3); animation: pulseGlowScan 2s infinite alternate; pointer-events: none; }
        @keyframes pulseGlowScan { 0% { box-shadow: 0 0 0 2000px rgba(0,0,0,0.6), inset 0 0 10px rgba(16, 185, 129, 0.1); } 100% { box-shadow: 0 0 0 2000px rgba(0,0,0,0.6), inset 0 0 30px rgba(16, 185, 129, 0.5); } }

        /* PERFECTLY ALIGNED LOGS */
        .log-filters { display: flex; gap: 10px; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); flex-wrap: wrap; }
        .filter-btn { background: var(--glass-bg-light); border: 1px solid var(--glass-border); color: var(--text-muted); padding: 6px 14px; border-radius: 20px; font-size: 11px; font-weight: bold; cursor: pointer; transition: 0.3s; text-transform: uppercase; letter-spacing: 1px; flex: 1; text-align: center; }
        .filter-btn:hover { background: var(--glass-bg-hover); color: var(--text-main); }
        .filter-btn.active { background: #00f2fe; color: #000; border-color: #00f2fe; box-shadow: 0 0 10px rgba(0, 242, 254, 0.4); }

        table { width: 100%; border-collapse: collapse; table-layout: fixed; } 
        th, td { padding: 14px 12px; text-align: left; border-bottom: 1px solid var(--glass-border); color: var(--text-main); vertical-align: middle; } 
        th { color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; } 
        
        .name-cell { display: flex; align-items: center; gap: 12px; }
        .log-avatar { width: 34px; height: 34px; border-radius: 50%; object-fit: cover; border: 2px solid var(--glass-border); background: var(--cam-placeholder); }
        .clickable-name { color: var(--text-main); font-weight: bold; cursor: pointer; text-decoration: none; transition: 0.3s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .clickable-name:hover { color: var(--orange-heading); }
        
        .status-present { color: var(--data-positive); font-weight: bold; font-size: 13px; }
        .status-absent { color: #ff4c4c; font-weight: bold; font-size: 13px; }
        .log-row { opacity: 0; transform: translateX(-20px); animation: slideInRow 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        .log-row:hover { background: var(--glass-bg-hover); border-radius: 8px; }
        @keyframes slideInRow { to { opacity: 1; transform: translateX(0); } }

        /* CHARTS */
        .charts-section { width: 100%; display: flex; gap: 20px; margin-top: 10px; flex-wrap: wrap; }
        .chart-box { flex: 1; min-width: 280px; display: flex; flex-direction: column; align-items: center; cursor: pointer; padding: 20px;} 
        .chart-container { position: relative; height: 250px; width: 100%; display: flex; justify-content: center; align-items: center; }
        .circular-progress { position: relative; width: 180px; height: 180px; transition: transform 0.4s ease; } .circular-progress:hover { transform: scale(1.1); }
        .progress-svg { transform: rotate(-90deg); width: 180px; height: 180px; } .progress-bg { fill: none; stroke: var(--empty-heat); stroke-width: 15; } .progress-bar { fill: none; stroke: var(--data-positive); stroke-width: 15; stroke-linecap: round; stroke-dasharray: 440; stroke-dashoffset: 440; transition: stroke-dashoffset 1.5s cubic-bezier(0.4, 0, 0.2, 1); filter: drop-shadow(0 0 10px rgba(16, 185, 129, 0.4)); }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 42px; font-weight: bold; color: var(--text-main); display: flex; align-items: baseline; } .progress-text span { font-size: 20px; color: var(--data-positive); margin-left: 2px; }

        .heatmap-panel { flex: 2; min-width: 300px; padding: 20px; } 
        .heat-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start; margin-top: 10px; padding: 10px 0; }
        .heat-box { width: 22px; height: 22px; border-radius: 4px; background: var(--empty-heat); position: relative; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); cursor: crosshair; }
        .heat-box:hover { transform: scale(1.4); z-index: 20; border: 1px solid var(--text-main); }
        .heat-1 { background: rgba(16, 185, 129, 0.3); } .heat-2 { background: rgba(16, 185, 129, 0.6); } .heat-3 { background: rgba(16, 185, 129, 1); box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); }
        .heat-box::after { content: attr(data-tooltip); position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--text-main); color: var(--bg-gradient-2); padding: 6px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; white-space: nowrap; opacity: 0; pointer-events: none; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 30; }
        .heat-box:hover::after { opacity: 1; bottom: 35px; }
        
        .insights-panel { flex: 1; min-width: 300px; padding: 20px; display: flex; flex-direction: column; }
        .insights-container { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; flex: 1; justify-content: center; }
        .insight-card { background: var(--glass-bg-light); border-left: 4px solid var(--data-positive); padding: 15px; border-radius: 8px; font-size: 14px; color: var(--text-main); animation: slideInRight 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); transition: transform 0.3s ease; line-height: 1.4; border: 1px solid transparent;}
        .insight-card:hover { transform: translateX(5px); background: var(--glass-bg-hover); border-color: var(--glass-border); }

        /* MODALS */
        .security-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(8px); animation: fadeInModal 0.3s ease; padding: 15px; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        
        .security-card { background: var(--glass-bg); padding: 30px; border-radius: 16px; border: 1px solid var(--glass-border); text-align: center; width: 100%; max-width: 380px; box-shadow: 0 15px 50px rgba(0,0,0,0.5); position: relative; transform: scale(0.9); animation: popModal 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popModal { to { transform: scale(1); } }
        .close-btn { position: absolute; top: 15px; right: 20px; color: var(--text-muted); cursor: pointer; font-size: 18px; transition: 0.3s; z-index: 10;} .close-btn:hover { color: #ff4c4c; transform: rotate(90deg) scale(1.2); }
        
        .pro-security-card { background: linear-gradient(145deg, rgba(15, 32, 39, 0.95) 0%, rgba(5, 10, 15, 0.98) 100%); background-image: radial-gradient(rgba(0, 242, 254, 0.05) 1px, transparent 1px); background-size: 15px 15px; border-top: 3px solid var(--primary); overflow: hidden; position: relative; }
        body.light-theme .pro-security-card { background: linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(240, 240, 245, 0.98) 100%); border-top: 3px solid var(--primary); }
        .pro-security-card::before { content: '\f577'; font-family: 'Font Awesome 5 Free'; font-weight: 900; position: absolute; top: -30px; right: -30px; font-size: 180px; color: rgba(0, 242, 254, 0.03); pointer-events: none; transform: rotate(-15deg); }

        .auth-header { display: flex; flex-direction: column; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--glass-border); padding-bottom: 20px; }
        .auth-icon { font-size: 45px; color: var(--primary); margin-bottom: 15px; filter: drop-shadow(0 0 15px var(--cyan-glow)); animation: floatAuth 3s infinite ease-in-out; }
        @keyframes floatAuth { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); filter: drop-shadow(0 0 25px var(--primary)); } }

        .secure-badge { display: inline-flex; align-items: center; gap: 6px; background: rgba(16, 185, 129, 0.1); color: var(--data-positive); padding: 5px 12px; border-radius: 20px; font-size: 10px; font-weight: bold; margin-top: 10px; border: 1px solid rgba(16, 185, 129, 0.3); text-transform: uppercase; letter-spacing: 1px; }

        .pro-input-group { position: relative; margin-bottom: 20px; text-align: left; }
        .pro-input-group i.input-icon { position: absolute; left: 16px; top: 16px; color: var(--text-muted); transition: 0.3s; font-size: 14px; z-index: 2; }
        .pro-input-group input { width: 100%; padding: 12px 12px 12px 45px; height: 50px; font-size: 14px; background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; color: var(--text-main); outline: none; transition: 0.3s; letter-spacing: 0.5px; }
        .pro-input-group input:focus { border-color: var(--primary); box-shadow: inset 0 0 10px rgba(0,242,254,0.1); }
        .pro-input-group input:focus + i.input-icon, .pro-input-group input:not(:placeholder-shown) + i.input-icon { color: var(--primary); filter: drop-shadow(0 0 5px var(--primary)); }
        .toggle-password { position: absolute; right: 15px; top: 17px; cursor: pointer; color: var(--text-muted); font-size: 12px; transition: 0.3s; font-weight: bold; } .toggle-password:hover { color: var(--text-main); }
        
        /* OTHER UTILS */
        .notif-card { max-width: 450px !important; }
        .notif-list { max-height: 350px; overflow-y: auto; text-align: left; padding-right: 5px; margin-top: 15px; }
        .notif-item { background: var(--glass-bg-light); padding: 12px 15px; margin-bottom: 12px; border-radius: 6px; display: flex; align-items: center; gap: 15px; animation: slideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); transition: all 0.3s ease; }
        .notif-item:hover { transform: translateX(5px); background: var(--glass-bg-hover); }
        #toast { position: fixed; top: 20px; right: 20px; padding: 15px 25px; border-radius: 8px; color: white; font-weight: 600; transform: translateX(150%); transition: 0.4s; z-index: 9999; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* MOBILE MEDIA QUERIES */
        @media (max-width: 768px) {
            body { padding: 10px; }
            .top-nav-bar { flex-direction: column; align-items: stretch; gap: 10px; }
            .top-right-nav { justify-content: space-between; width: 100%; }
            .nav-btn { flex: 1; text-align: center; padding: 12px 10px; font-size: 13px; }
            .summary-card { min-width: 45%; flex-direction: column; text-align: center; padding: 15px; gap: 10px; }
            .controls .btn-primary, .controls .btn-stop { padding: 18px; font-size: 16px; margin-bottom: 5px; animation: none; }
            
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            .log-row { border: 1px solid var(--glass-border); border-radius: 12px; margin-bottom: 15px; padding: 15px; background: var(--glass-bg-light); box-shadow: 0 4px 10px rgba(0,0,0,0.05); height: auto; }
            .log-row td { border: none; position: relative; padding: 10px 10px 10px 40%; text-align: right; font-size: 14px; display: flex; justify-content: flex-end; align-items: center;}
            .log-row td::before { content: attr(data-label); position: absolute; left: 15px; width: 35%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: bold; color: var(--text-muted); font-size: 12px; text-transform: uppercase; }
        }
    </style>
</head>
<body>

    <div class="top-nav-bar stagger-in" style="animation-delay: 0.1s;">
        <button id="adminBtn" class="nav-btn" onclick="openSecurityModal()">
            <i class="fas fa-users-cog"></i> Manage Students
        </button>
        <div class="top-right-nav">
            <button class="nav-btn" id="themeToggleBtn" onclick="toggleTheme()"><i class="fas fa-sun" id="themeIcon"></i> <span id="themeText">Light Mode</span></button>
            <button class="nav-btn" onclick="openNotifModal()"><i class="fas fa-bell"></i> Alerts <div id="notifBadge" class="notif-badge">0</div></button>
            <button class="nav-btn" onclick="openHelpModal()"><i class="fas fa-question-circle"></i> Help</button>
            <button class="nav-btn btn-logout" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </div>
    </div>

    <div class="header stagger-in" style="animation-delay: 0.2s;">
        <h1>SHRI SHIVAJI COLLEGE, PARBHANI</h1>
        <h2>Smart Attendance Live Dashboard</h2>
        <div class="live-clock-widget" id="liveClockWidget"><i class="far fa-clock"></i> <span id="liveDate">Loading...</span> | <span id="liveTime">--:--:--</span></div>
    </div>

    <div class="summary-container stagger-in" style="animation-delay: 0.3s;">
        <div class="summary-card glass-card">
            <div class="summary-icon icon-blue"><i class="fas fa-user-graduate"></i></div>
            <div class="summary-info"><h4>Total Students</h4><h2 id="summaryTotal" class="skeleton skeleton-block"></h2></div>
        </div>
        <div class="summary-card glass-card">
            <div class="summary-icon icon-green"><i class="fas fa-user-check"></i></div>
            <div class="summary-info"><h4>Present Today</h4><h2 id="summaryPresent" class="skeleton skeleton-block"></h2></div>
        </div>
        <div class="summary-card glass-card">
            <div class="summary-icon icon-red"><i class="fas fa-user-times"></i></div>
            <div class="summary-info"><h4>Absent Today</h4><h2 id="summaryAbsent" class="skeleton skeleton-block"></h2></div>
        </div>
        <div class="summary-card glass-card">
            <div class="summary-icon icon-orange"><i class="fas fa-chart-line"></i></div>
            <div class="summary-info"><h4>Attendance %</h4><h2 id="summaryPercent" class="skeleton skeleton-block"></h2></div>
        </div>
    </div>

    <div class="dashboard-container">
        <div class="panel-card glass-card camera-section stagger-in" style="animation-delay: 0.4s;">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; margin-bottom: 20px;">
                <h3 style="border: none; padding: 0; margin: 0;"><i class="fas fa-camera"></i> Live Scanner</h3>
                <div class="status-badge" id="camStatusBadge">
                    <div class="status-dot dot-offline" id="camStatusDot"></div>
                    <span id="camStatusText" style="color: var(--text-muted);">SYSTEM STANDBY</span>
                </div>
            </div>

            <div id="camera-placeholder">
                <div class="demo-face-box"></div>
                <i class="fas fa-fingerprint pulse-icon"></i>
                <p style="color: #00f2fe; font-weight: bold; letter-spacing: 2px; margin-top: 25px; position: relative; z-index: 2;">AI ENGINE IDLE</p>
                <p style="font-size: 11px; color: var(--text-muted); margin-top: 0; position: relative; z-index: 2;">Awaiting camera stream...</p>
            </div>
            
            <div id="camera-wrapper">
                <img id="webcam" style="display: none;">
                <div id="face-guide" class="face-guide"></div>
            </div>
            
            <div class="controls">
                <button id="startBtn" class="btn-primary" onclick="startAttendance()"><i class="fas fa-play"></i> START CAMERA</button>
                <button id="scanBtn" class="btn-primary" style="display: none;" onclick="markAttendance()"><i class="fas fa-expand"></i> SCAN ATTENDANCE</button>
                <button id="stopBtn" class="btn-stop" style="display: none;" onclick="stopAttendance()"><i class="fas fa-stop"></i> SHUT DOWN</button>
            </div>
            <canvas id="dashCanvas" style="display:none;"></canvas>
        </div>

        <div class="panel-card glass-card logs-section stagger-in" style="animation-delay: 0.5s;">
            <h3 style="margin-bottom: 15px;"><i class="fas fa-list-alt"></i> Real-Time Logs</h3>
            <div class="log-filters">
                <button class="filter-btn active" id="filter-all" onclick="setLogFilter('all')">All</button>
                <button class="filter-btn" id="filter-present" onclick="setLogFilter('present')">Present</button>
                <button class="filter-btn" id="filter-absent" onclick="setLogFilter('absent')">Absent</button>
            </div>
            <div style="max-height: 400px; overflow-y: auto;">
                <table>
                    <colgroup><col style="width: 15%;"><col style="width: 45%;"><col style="width: 20%;"><col style="width: 20%;"></colgroup>
                    <thead><tr><th>ID</th><th>Student Profile</th><th>Time</th><th>Status</th></tr></thead>
                    <tbody id="logTableBody">
                        <tr><td><div class="skeleton skeleton-block" style="width: 40px;"></div></td><td><div class="name-cell"><div class="skeleton skeleton-avatar"></div><div class="skeleton skeleton-block" style="width: 120px;"></div></div></td><td><div class="skeleton skeleton-block" style="width: 60px;"></div></td><td><div class="skeleton skeleton-block" style="width: 70px;"></div></td></tr>
                        <tr><td><div class="skeleton skeleton-block" style="width: 40px;"></div></td><td><div class="name-cell"><div class="skeleton skeleton-avatar"></div><div class="skeleton skeleton-block" style="width: 90px;"></div></div></td><td><div class="skeleton skeleton-block" style="width: 60px;"></div></td><td><div class="skeleton skeleton-block" style="width: 70px;"></div></td></tr>
                        <tr><td><div class="skeleton skeleton-block" style="width: 40px;"></div></td><td><div class="name-cell"><div class="skeleton skeleton-avatar"></div><div class="skeleton skeleton-block" style="width: 150px;"></div></div></td><td><div class="skeleton skeleton-block" style="width: 60px;"></div></td><td><div class="skeleton skeleton-block" style="width: 70px;"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="charts-section">
            <div class="panel-card glass-card chart-box stagger-in" style="animation-delay: 0.6s;">
                <h3><i class="fas fa-percentage"></i> Overall</h3>
                <div class="chart-container">
                    <div class="circular-progress">
                        <svg class="progress-svg"><circle class="progress-bg" cx="90" cy="90" r="70"></circle><circle class="progress-bar" id="animProgressBar" cx="90" cy="90" r="70"></circle></svg>
                        <div class="progress-text"><div id="overallPercentage">0</div><span>%</span></div>
                    </div>
                </div>
            </div>
            <div class="panel-card glass-card chart-box stagger-in" style="animation-delay: 0.7s;">
                <h3><i class="fas fa-chart-pie"></i> Overview</h3>
                <div class="chart-container"><canvas id="pieChart"></canvas></div>
            </div>
            <div class="panel-card glass-card chart-box stagger-in" style="animation-delay: 0.8s;">
                <h3><i class="fas fa-chart-bar"></i> 7-Day Trend</h3>
                <div class="chart-container"><canvas id="barChart"></canvas></div>
            </div>
        </div>

        <div style="width: 100%; display: flex; gap: 20px; flex-wrap: wrap; margin-top: 10px;">
            <div class="panel-card glass-card heatmap-panel stagger-in" style="animation-delay: 0.9s;">
                <h3><i class="fas fa-calendar-alt"></i> 30-Day Attendance Heatmap</h3>
                <div class="heat-grid" id="heatmapContainer"><div class="skeleton skeleton-block" style="width: 100%; height: 60px;"></div></div>
                <div style="display: flex; align-items: center; justify-content: flex-end; gap: 6px; font-size: 11px; color: var(--text-muted); margin-top: 15px;">
                    Less <div class="heat-box heat-0"></div><div class="heat-box heat-1"></div><div class="heat-box heat-2"></div><div class="heat-box heat-3"></div> More
                </div>
            </div>

            <div class="panel-card glass-card insights-panel stagger-in" style="animation-delay: 1.0s;">
                <h3><i class="fas fa-brain"></i> AI Smart Insights</h3>
                <div id="insightsContainer" class="insights-container">
                    <div class="skeleton skeleton-block" style="height: 50px;"></div>
                    <div class="skeleton skeleton-block" style="height: 50px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="securityModal" class="security-modal">
        <div class="security-card pro-security-card" id="authCard">
            <i class="fas fa-times close-btn" onclick="closeSecurityModal()"></i>
            
            <div class="auth-header">
                <i class="fas fa-shield-alt auth-icon" id="authLockIcon"></i>
                <h3 style="margin:0; letter-spacing: 2px; color: var(--text-main) !important;">RESTRICTED ACCESS</h3>
                <div class="secure-badge"><i class="fas fa-lock"></i> 256-Bit Encrypted Connection</div>
            </div>

            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 25px; line-height: 1.6;">
                Administration clearance required. Verify your identity to access the master dataset controls.
            </p>

            <form id="verifyForm">
                <div class="input-group pro-input-group">
                    <input type="email" id="verifyEmail" placeholder="Staff Email Address" required autocomplete="off">
                    <i class="fas fa-envelope input-icon"></i>
                </div>
                
                <div class="input-group pro-input-group">
                    <input type="password" id="verifyPassword" placeholder="Authorization Password" required>
                    <i class="fas fa-key input-icon"></i>
                    <span class="toggle-password" onclick="toggleVisibility('verifyPassword', this)">SHOW</span>
                </div>

                <button type="submit" class="btn-primary" id="verifySubmitBtn" style="height: 52px; font-size: 15px; letter-spacing: 1.5px; margin-top: 10px; width: 100%;">
                    <i class="fas fa-fingerprint" style="font-size: 18px;"></i> INITIATE LOGIN
                </button>
                
                <div id="verifyError" style="display:none; color: #ff4c4c; font-size: 12px; margin-top: 15px; text-align: center; background: rgba(255, 76, 76, 0.1); padding: 10px; border-radius: 6px; border: 1px solid rgba(255, 76, 76, 0.3);">
                    <i class="fas fa-exclamation-triangle"></i> Access Denied. Invalid credentials.
                </div>
            </form>
            
            <div style="margin-top: 25px; font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; border-top: 1px solid var(--glass-border); padding-top: 15px; display: flex; justify-content: space-between;">
                <span>IP: <span style="color: var(--primary);">127.0.0.1</span></span>
                <span>Session: <span id="sessionID" style="color: var(--primary);"></span></span>
            </div>
        </div>
    </div>

    <div id="profileModal" class="security-modal">
        <div class="security-card" style="border-color: #00f2fe !important;">
            <i class="fas fa-times close-btn" onclick="closeProfileModal()"></i>
            <div style="text-align: center;">
                <img id="profileImg" src="" style="width:110px; height:110px; border-radius:50%; border: 4px solid var(--glass-border); object-fit: cover;">
                <h3 id="profileName" style="margin-top: 15px; font-size: 22px;">Loading...</h3>
                <p id="profileId" style="color: var(--text-muted); font-size: 13px; font-weight: bold;">ID: ---</p>
            </div>
            <div style="display:flex; justify-content: space-around; margin-bottom: 20px; background: var(--glass-bg-light); padding: 15px 10px; border-radius: 12px; border: 1px solid var(--glass-border);">
                <div style="text-align:center;"><div style="font-size: 24px; color: var(--data-positive); font-weight: bold;" id="profilePercent">0%</div><div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Overall Rate</div></div>
                <div style="text-align:center;"><div style="font-size: 24px; color: var(--text-main); font-weight: bold;" id="profilePresent">0</div><div style="font-size: 11px; color: var(--text-muted); text-transform: uppercase;">Days Present</div></div>
            </div>
            <h4 style="font-size: 14px; text-align:left; border-bottom: 1px solid var(--glass-border); padding-bottom: 8px;"><i class="fas fa-history"></i> Recent Scans</h4>
            <div id="profileHistory" style="max-height: 150px; overflow-y: auto; text-align:left;"></div>
        </div>
    </div>

    <div id="notifModal" class="security-modal"><div class="security-card"><i class="fas fa-times close-btn" onclick="closeNotifModal()"></i><h3><i class="fas fa-bell"></i> Notification Center</h3><div id="notificationList" class="notif-list"></div></div></div>
    
    <div id="helpModal" class="security-modal"><div class="security-card notif-card"><i class="fas fa-times close-btn" onclick="closeHelpModal()"></i><h3><i class="fas fa-info-circle"></i> System Quick Guide</h3><div style="text-align: left;"><h4 style="margin-bottom: 5px;"><i class="fas fa-camera-retro"></i> 1. Marking Attendance</h4><p style="font-size: 13px; color: var(--text-muted); margin-top: 0;">Click the <b>START CAMERA</b> button. Ensure your face is visible within the dashed circle, then click <b>SCAN ATTENDANCE</b> to log your time.</p><h4 style="margin-bottom: 5px; margin-top: 15px;"><i class="fas fa-chart-line"></i> 2. Viewing Analytics</h4><p style="font-size: 13px; color: var(--text-muted); margin-top: 0;">Scroll down to view real-time graphical charts and the 30-Day Predictive Heatmap.</p><h4 style="margin-bottom: 5px; margin-top: 15px;"><i class="fas fa-user-plus"></i> 3. Admin & Exports</h4><p style="font-size: 13px; color: var(--text-muted); margin-top: 0;">Click the <b>Manage Students</b> button and enter staff credentials to enroll new faces or generate PDF/CSV Reports.</p></div></div></div>
    
    <div id="toast">Message</div>

    <script>
        // --- THEME TOGGLE LOGIC ---
        function toggleTheme() {
            const body = document.body; const isLight = body.classList.toggle('light-theme');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            document.getElementById('themeIcon').className = isLight ? 'fas fa-moon' : 'fas fa-sun';
            document.getElementById('themeText').innerText = isLight ? 'Dark Mode' : 'Light Mode';
            Chart.defaults.color = isLight ? '#4b5563' : '#d1d5db';
            if(!isFirstLoad) updateRealLogs();
        }

        window.addEventListener('DOMContentLoaded', () => { 
            if (localStorage.getItem('theme') === 'light') { toggleTheme(); }
            addNotification("System AI Boot Sequence Complete.", "fas fa-rocket", "#10b981"); 
            document.getElementById('sessionID').innerText = Math.random().toString(36).substring(2, 10).toUpperCase();
        });

        // --- UTILS ---
        function showToast(msg, type) { const t = document.getElementById('toast'); t.innerText = msg; t.style.background = type === 'success' ? 'var(--data-positive)' : '#ff4c4c'; t.style.color = type === 'success' ? '#000' : '#fff'; t.style.transform = 'translateX(0)'; setTimeout(() => { t.style.transform = 'translateX(150%)'; }, 3500); }
        function updateLiveClock() { const now = new Date(); document.getElementById('liveDate').innerText = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' }); let h = now.getHours(), m = now.getMinutes(), s = now.getSeconds(); const ampm = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12; document.getElementById('liveTime').innerText = `${h}:${m<10?'0'+m:m}:${s<10?'0'+s:s} ${ampm}`; }
        setInterval(updateLiveClock, 1000); updateLiveClock(); 
        function toggleVisibility(inputId, icon) { const i = document.getElementById(inputId); const t = i.getAttribute('type') === 'password' ? 'text' : 'password'; i.setAttribute('type', t); icon.textContent = t === 'password' ? 'SHOW' : 'HIDE'; }

        // --- NOTIFICATIONS ---
        let unreadNotifs = 0, isFirstLoad = true, seenAttendanceIds = new Set();
        function addNotification(message, iconClass, color, playSound = false) { 
            const list = document.getElementById('notificationList'); const timeString = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
            list.insertAdjacentHTML('afterbegin', `<div class="notif-item" style="border-left-color: ${color}; padding: 10px; border-bottom: 1px solid var(--glass-border);"><i class="${iconClass} notif-icon" style="color: ${color}; margin-right: 10px;"></i><div class="notif-content" style="display:inline-block;"><div class="notif-msg" style="font-size:13px; color:var(--text-main);">${message}</div><div class="notif-time" style="font-size:11px; color:var(--text-muted);">${timeString}</div></div></div>`); 
            unreadNotifs++; const badge = document.getElementById('notifBadge'); badge.innerText = unreadNotifs; badge.style.display = 'flex'; 
            badge.classList.remove('badge-animate'); void badge.offsetWidth; badge.classList.add('badge-animate');
            if(playSound) { new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(e => {}); showToast(message, 'success'); }
        }

        // --- MODAL CONTROLS ---
        function openNotifModal() { document.getElementById('notifModal').style.display = 'flex'; unreadNotifs = 0; document.getElementById('notifBadge').style.display = 'none'; }
        function closeNotifModal() { document.getElementById('notifModal').style.display = 'none'; }
        function closeProfileModal() { document.getElementById('profileModal').style.display = 'none'; }
        function openHelpModal() { document.getElementById('helpModal').style.display = 'flex'; }
        function closeHelpModal() { document.getElementById('helpModal').style.display = 'none'; }
        function logout() { localStorage.removeItem("userRole"); window.location.href = "login.html"; }

        function openStudentProfile(studentId) {
            document.getElementById('profileModal').style.display = 'flex'; document.getElementById('profileName').innerText = "Fetching..."; document.getElementById('profileHistory').innerHTML = "<i class='fas fa-spinner fa-spin'></i>";
            fetch(`/api/student_profile/${studentId}`).then(res => res.json()).then(data => {
                if (data.error) return showToast(data.error, "error");
                document.getElementById('profileName').innerText = data.name; document.getElementById('profileId').innerText = `Student ID: ${data.id}`; document.getElementById('profileImg').src = data.photo; document.getElementById('profilePercent').innerText = `${data.attendance_percent}%`; document.getElementById('profilePresent').innerText = data.present_days;
                let hHtml = ""; if (data.history.length === 0) { hHtml = "<p>No records found.</p>"; } else { data.history.forEach(log => { hHtml += `<div style="display:flex; justify-content:space-between; background: var(--glass-bg-light); padding: 12px; margin-bottom: 8px; border-left: 3px solid var(--data-positive);"><span style="color:var(--text-main); font-weight:bold;">${log.date}</span><span style="color:var(--data-positive);">${log.time}</span></div>`; }); } document.getElementById('profileHistory').innerHTML = hHtml;
            }).catch(e => showToast("Database error.", "error"));
        }

        // --- PRO STAFF VERIFICATION ---
        function openSecurityModal() { stopAttendance(); document.getElementById('securityModal').style.display = 'flex'; }
        function closeSecurityModal() { 
            document.getElementById('securityModal').style.display = 'none'; document.getElementById('verifyForm').reset(); document.getElementById('verifyError').style.display = 'none';
            document.getElementById('verifySubmitBtn').innerHTML = '<i class="fas fa-fingerprint" style="font-size: 18px;"></i> INITIATE LOGIN'; document.getElementById('authLockIcon').className = "fas fa-shield-alt auth-icon"; document.getElementById('authLockIcon').style.color = "var(--primary)";
        }

        document.getElementById('verifyForm').addEventListener('submit', function(e) { 
            e.preventDefault(); 
            const email = document.getElementById('verifyEmail').value; const pass = document.getElementById('verifyPassword').value;
            const savedEmail = localStorage.getItem("savedEmail"); const savedPassword = localStorage.getItem("savedPassword");
            const btn = document.getElementById('verifySubmitBtn'); const icon = document.getElementById('authLockIcon'); const err = document.getElementById('verifyError'); const authCard = document.getElementById('authCard');

            err.style.display = 'none'; btn.innerHTML = '<i class="fas fa-circle-notch fa-spin" style="font-size: 18px;"></i> VERIFYING VECTORS...'; btn.disabled = true; btn.style.opacity = '0.8';

            setTimeout(() => {
                if ((email === savedEmail && pass === savedPassword) || (email === "admin@gmail.com" && pass === "Admin@2026")) { 
                    icon.className = "fas fa-unlock-alt auth-icon"; icon.style.color = "var(--data-positive)"; icon.style.animation = "none"; 
                    btn.style.background = "linear-gradient(135deg, #10b981 0%, #059669 100%)"; btn.style.boxShadow = "0 4px 15px rgba(16, 185, 129, 0.4)"; btn.style.opacity = '1';
                    btn.innerHTML = '<i class="fas fa-check-circle" style="font-size: 18px;"></i> CLEARANCE GRANTED';
                    new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(e=>{});
                    setTimeout(() => { window.location.href = "admin.html"; }, 800);
                } else { 
                    btn.innerHTML = '<i class="fas fa-fingerprint" style="font-size: 18px;"></i> INITIATE LOGIN'; btn.disabled = false; btn.style.opacity = '1'; err.style.display = 'block'; 
                    authCard.style.animation = 'none'; authCard.offsetHeight; authCard.style.animation = 'shake 0.4s ease'; 
                    new Audio('https://assets.mixkit.co/active_storage/sfx/2997/2997-preview.mp3').play().catch(e=>{});
                } 
            }, 1200); 
        });

        // --- ORIGINAL CAMERA LOGIC (SNAPSHOT BASED) ---
        function speak(text) { if ('speechSynthesis' in window) { const u = new SpeechSynthesisUtterance(text); u.rate = 1.0; u.pitch = 1.1; window.speechSynthesis.speak(u); } }
        function setCamStatus(state, msg) {
            const dot = document.getElementById('camStatusDot'); const text = document.getElementById('camStatusText'); dot.className = 'status-dot';
            if (state === 'offline') { dot.classList.add('dot-offline'); text.style.color = 'var(--text-muted)'; } else if (state === 'active') { dot.classList.add('dot-active'); text.style.color = 'var(--data-positive)'; } else if (state === 'scanning') { dot.classList.add('dot-scanning'); text.style.color = '#f2c94c'; } else if (state === 'error') { dot.classList.add('dot-error'); text.style.color = '#ff4c4c'; }
            text.innerText = msg;
        }

        function startAttendance() { document.getElementById('camera-placeholder').style.display='none'; document.getElementById('camera-wrapper').style.display='block'; document.getElementById('webcam').src="/video_feed"; document.getElementById('webcam').style.display="block"; document.getElementById('startBtn').style.display='none'; document.getElementById('stopBtn').style.display='flex'; document.getElementById('scanBtn').style.display='flex'; setCamStatus('active', 'ðŸŸ¢ CAMERA ACTIVE'); }
        function stopAttendance() { document.getElementById('webcam').src=""; document.getElementById('webcam').style.display="none"; document.getElementById('camera-wrapper').style.display='none'; document.getElementById('camera-placeholder').style.display='flex'; document.getElementById('startBtn').style.display='flex'; document.getElementById('stopBtn').style.display='none'; document.getElementById('scanBtn').style.display='none'; setCamStatus('offline', 'SYSTEM STANDBY'); }
        
        function takeSnapshot() { 
            const img = document.getElementById('webcam'); 
            const c = document.getElementById('dashCanvas'); 
            c.width = 640; c.height = 480; 
            c.getContext('2d').drawImage(img, 0, 0, c.width, c.height); 
            return c.toDataURL('image/jpeg', 0.8); 
        }

        async function markAttendance() { 
            const btn = document.getElementById('scanBtn'); btn.disabled = true; btn.innerHTML = "<i class='fas fa-spinner fa-spin'></i> Scanning AI..."; setCamStatus('scanning', 'ðŸŸ¡ SCANNING BIOMETRICS...');
            try {
                const res = await fetch('/mark_attendance_live', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ image: takeSnapshot() }) });
                const data = await res.json(); 
                if(data.status === 'success') { 
                    new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(e=>{}); 
                    showToast(`${data.name} âœ… | ${data.confidence}`, "success"); speak(`${data.name} present.`); updateRealLogs(); setCamStatus('active', 'ðŸŸ¢ MATCH FOUND'); 
                } else { 
                    new Audio('https://assets.mixkit.co/active_storage/sfx/2997/2997-preview.mp3').play().catch(e=>{}); 
                    showToast(data.message, "error"); speak("Warning."); setCamStatus('error', 'ðŸ”´ NO MATCH'); setTimeout(() => setCamStatus('active', 'ðŸŸ¢ CAMERA ACTIVE'), 3000); 
                }
            } catch(e) { showToast("AI Error", "error"); setCamStatus('error', 'ðŸ”´ ERROR'); setTimeout(() => setCamStatus('active', 'ðŸŸ¢ CAMERA ACTIVE'), 3000); } finally { btn.disabled = false; btn.innerHTML = "<i class='fas fa-expand'></i> SCAN ATTENDANCE"; } 
        }

        // --- DASHBOARD LOGIC & MATH LOCK ---
        let currentLogFilter = 'all'; let lastLogHTML = "";
        function setLogFilter(filter) { currentLogFilter = filter; document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active')); document.getElementById('filter-' + filter).classList.add('active'); lastLogHTML = ""; updateRealLogs(); }

        Chart.defaults.color = '#d1d5db'; Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
        let pieChartInstance = null; let barChartInstance = null; let currentDisplayedPercentage = 0;

        function animateProgressNumber(target) { const textElement = document.getElementById('overallPercentage'); if (currentDisplayedPercentage === target) return; let start = currentDisplayedPercentage, end = target, startTime = null; function step(timestamp) { if (!startTime) startTime = timestamp; let progress = Math.min((timestamp - startTime) / 1500, 1); textElement.innerText = Math.floor(start + (end - start) * (progress * (2 - progress))); if (progress < 1) window.requestAnimationFrame(step); else currentDisplayedPercentage = target; } window.requestAnimationFrame(step); }

        async function updateRealLogs() {
            try {
                const [attRes, stdRes] = await Promise.all([ fetch('/get_today_attendance'), fetch('/get_students_db') ]);
                const attData = await attRes.json(); const stdData = await stdRes.json();
                const presentIds = new Set(attData.map(row => row[0].toString())); let logs = [];

                attData.forEach(row => { 
                    logs.push({ id: row[0], name: row[1], time: row[2], status: 'Present' }); 
                    if (!isFirstLoad && !seenAttendanceIds.has(row[0])) { addNotification(`${row[1]} marked present!`, "fas fa-check-circle", "#10b981", true); } 
                    seenAttendanceIds.add(row[0]); 
                });
                
                stdData.forEach(row => { if (!presentIds.has(row[0].toString())) { logs.push({ id: row[0], name: row[1], time: '--:--', status: 'Absent' }); } });

                if (currentLogFilter === 'present') logs = logs.filter(l => l.status === 'Present'); if (currentLogFilter === 'absent') logs = logs.filter(l => l.status === 'Absent');

                let newHTML = "";
                if(logs.length === 0) { newHTML = `<tr><td colspan="4" style="text-align:center;">No records.</td></tr>`; } 
                else { logs.forEach((log, index) => {
                    const statusHtml = log.status === 'Present' ? `<span class="status-present">Present</span>` : `<span class="status-absent">Absent</span>`;
                    const timeColor = log.status === 'Absent' ? 'var(--text-muted)' : 'var(--text-main)';
                    const avatarUrl = `/dataset/User.${log.id}.1.jpg`; const fallback = `https://ui-avatars.com/api/?name=${encodeURIComponent(log.name)}&background=2a313c&color=00f2fe`;
                    newHTML += `<tr class="log-row" style="animation-delay: ${Math.min(index * 0.08, 0.5)}s;">
                        <td data-label="ID">${log.id}</td>
                        <td data-label="Profile"><div class="name-cell"><img src="${avatarUrl}" onerror="this.src='${fallback}'" class="log-avatar"><a href="#" class="clickable-name" onclick="openStudentProfile('${log.id}'); return false;">${log.name}</a></div></td>
                        <td data-label="Time" style="color: ${timeColor};">${log.time}</td>
                        <td data-label="Status">${statusHtml}</td>
                    </tr>`;
                }); }

                if (newHTML !== lastLogHTML) { document.getElementById('logTableBody').innerHTML = newHTML; lastLogHTML = newHTML; }
                
                // ðŸ›¡ï¸ MATH SAFETY LOCK
                let totalStudents = stdData.length; 
                let presentCount = presentIds.size; 
                if (totalStudents < presentCount) { totalStudents = presentCount; } 
                
                let absentCount = totalStudents - presentCount;
                let targetPercentage = totalStudents === 0 ? 0 : Math.round((presentCount / totalStudents) * 100);
                
                const removeSkeleton = (id, val) => { const el = document.getElementById(id); el.classList.remove('skeleton', 'skeleton-block'); el.innerText = val; };
                removeSkeleton('summaryTotal', totalStudents); removeSkeleton('summaryPresent', presentCount); 
                removeSkeleton('summaryAbsent', absentCount); removeSkeleton('summaryPercent', targetPercentage + "%");

                document.getElementById('animProgressBar').style.strokeDashoffset = 440 - (targetPercentage / 100) * 440; animateProgressNumber(targetPercentage);

                const pieCtx = document.getElementById('pieChart').getContext('2d');
                if (pieChartInstance) pieChartInstance.destroy();
                const isLight = document.body.classList.contains('light-theme'); const absentColor = isLight ? '#d1d5db' : '#ff4c4c'; 
                pieChartInstance = new Chart(pieCtx, { type: 'doughnut', data: { labels: ['Present', 'Absent'], datasets: [{ data: [presentCount, absentCount], backgroundColor: ['#10b981', absentColor], borderWidth: 0, hoverOffset: 6 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: Chart.defaults.color } }, tooltip: { callbacks: { label: function(context) { return `  ${context.raw} Students`; } } } } } });

            } catch(e) { console.error("Logs Update Error:", e); }

            // HEATMAP AND BAR CHART
            fetch('/api/heatmap_data').then(r => r.json()).then(data => {
                const container = document.getElementById('heatmapContainer'); let html = ""; 
                for(let i=29; i>=0; i--) { 
                    let d = new Date(); d.setDate(d.getDate() - i); let dateStr = d.toISOString().split('T')[0]; 
                    let count = data[dateStr] || 0; let level = 0; 
                    if (count > 0 && count <= 5) level = 1; else if (count > 5 && count <= 15) level = 2; else if (count > 15) level = 3; 
                    html += `<div class="heat-box heat-${level}"></div>`; 
                } 
                container.innerHTML = html;

                let barDates = []; let barCounts = [];
                for(let i=6; i>=0; i--) {
                    let d = new Date(); d.setDate(d.getDate() - i); barDates.push(d.toLocaleDateString('en-US', {weekday: 'short'}));
                    let dbDate = d.toISOString().split('T')[0]; barCounts.push(data[dbDate] || 0);
                }

                const barCtx = document.getElementById('barChart').getContext('2d'); 
                if (barChartInstance) barChartInstance.destroy();
                barChartInstance = new Chart(barCtx, { 
                    type: 'bar', 
                    data: { labels: barDates, datasets: [{ label: 'Present', data: barCounts, backgroundColor: '#10b981', borderRadius: 4, hoverBackgroundColor: '#00f2fe' }] }, 
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, color: Chart.defaults.color } }, x: { ticks: { color: Chart.defaults.color } } } } 
                });
            }).catch(e => {});

            fetch('/api/smart_insights').then(r => r.json()).then(data => {
                const container = document.getElementById('insightsContainer'); let html = ""; data.forEach(insight => { html += `<div class="insight-card">${insight}</div>`; }); container.innerHTML = html;
            }).catch(e => {});

            isFirstLoad = false;
        }

        setTimeout(updateRealLogs, 800); setInterval(updateRealLogs, 3000);
    </script>
</body>
</html>